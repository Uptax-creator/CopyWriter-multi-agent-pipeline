# üèóÔ∏è Plano de Arquitetura Independente - MCP Servers

## üìã Estrat√©gia de Implementa√ß√£o

Baseado na an√°lise comparativa, implementaremos o **modelo independente com biblioteca comum** para otimizar flexibilidade, manutenibilidade e custos.

## üéØ Estrutura Proposta

```
erp-mcp-ecosystem/
‚îú‚îÄ‚îÄ common/                     # Biblioteca comum (compartilhada)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ auth/                   # Autentica√ß√£o padronizada
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base_auth.py        # Classe base de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ token_manager.py    # Gerenciamento de tokens
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ credential_store.py # Armazenamento seguro
‚îÇ   ‚îú‚îÄ‚îÄ tools/                  # Ferramentas base
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base_tool.py        # Classe base para ferramentas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validators.py       # Valida√ß√µes comuns
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ formatters.py       # Formata√ß√£o de dados
‚îÇ   ‚îú‚îÄ‚îÄ naming/                 # Nomenclatura universal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ universal_names.py  # Mapeamento de nomes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ field_mappings.py   # Mapeamento de campos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ aliases.py          # Sistema de aliases
‚îÇ   ‚îú‚îÄ‚îÄ utils/                  # Utilit√°rios comuns
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ http_client.py      # Cliente HTTP padr√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ date_utils.py       # Utilit√°rios de data
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document_utils.py   # Valida√ß√£o CPF/CNPJ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ currency_utils.py   # Utilit√°rios monet√°rios
‚îÇ   ‚îú‚îÄ‚îÄ mcp/                    # Base MCP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base_server.py      # Servidor MCP base
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ protocol.py         # Protocolo JSON-RPC
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ error_handler.py    # Tratamento de erros
‚îÇ   ‚îî‚îÄ‚îÄ config/                 # Configura√ß√µes
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ base_config.py      # Configura√ß√£o base
‚îÇ       ‚îî‚îÄ‚îÄ logging_config.py   # Configura√ß√£o de logs
‚îú‚îÄ‚îÄ omie-mcp/                   # Servidor independente Omie
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ server.py               # Servidor MCP espec√≠fico
‚îÇ   ‚îú‚îÄ‚îÄ client/                 # Cliente Omie
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ omie_client.py      # Cliente HTTP Omie
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ endpoints.py        # Endpoints da API
‚îÇ   ‚îú‚îÄ‚îÄ tools/                  # Ferramentas espec√≠ficas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ clientes.py         # Ferramentas de clientes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fornecedores.py     # Ferramentas de fornecedores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ categorias.py       # Ferramentas de categorias
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contas.py           # Ferramentas de contas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ departamentos.py    # Ferramentas de departamentos
‚îÇ   ‚îú‚îÄ‚îÄ config/                 # Configura√ß√£o espec√≠fica
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ omie_config.py      # Config Omie
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt        # Depend√™ncias espec√≠ficas
‚îú‚îÄ‚îÄ nibo-mcp/                   # Servidor independente Nibo
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ server.py               # Servidor MCP espec√≠fico
‚îÇ   ‚îú‚îÄ‚îÄ client/                 # Cliente Nibo
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nibo_client.py      # Cliente HTTP Nibo
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ endpoints.py        # Endpoints da API
‚îÇ   ‚îú‚îÄ‚îÄ tools/                  # Ferramentas espec√≠ficas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ clientes.py         # Ferramentas de clientes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fornecedores.py     # Ferramentas de fornecedores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ categorias.py       # Ferramentas de categorias
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contas.py           # Ferramentas de contas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ centros_custo.py    # Ferramentas de centros custo
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ socios.py           # Ferramentas de s√≥cios
‚îÇ   ‚îú‚îÄ‚îÄ config/                 # Configura√ß√£o espec√≠fica
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ nibo_config.py      # Config Nibo
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt        # Depend√™ncias espec√≠ficas
‚îú‚îÄ‚îÄ sap-mcp/                    # Servidor independente SAP
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ server.py               # Servidor MCP espec√≠fico
‚îÇ   ‚îú‚îÄ‚îÄ client/                 # Cliente SAP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sap_client.py       # Cliente SAP
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ endpoints.py        # Endpoints SAP
‚îÇ   ‚îú‚îÄ‚îÄ tools/                  # Ferramentas espec√≠ficas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ customers.py        # Ferramentas de clientes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vendors.py          # Ferramentas de fornecedores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ materials.py        # Ferramentas de materiais
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ accounts.py         # Ferramentas de contas
‚îÇ   ‚îú‚îÄ‚îÄ config/                 # Configura√ß√£o espec√≠fica
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sap_config.py       # Config SAP
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt        # Depend√™ncias espec√≠ficas
‚îú‚îÄ‚îÄ scripts/                    # Scripts de automa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ create_erp_server.py    # Gerador de novos servidores
‚îÇ   ‚îú‚îÄ‚îÄ validate_naming.py      # Validador de nomenclatura
‚îÇ   ‚îú‚îÄ‚îÄ test_all_servers.py     # Testes integrados
‚îÇ   ‚îî‚îÄ‚îÄ deploy.py               # Script de deploy
‚îú‚îÄ‚îÄ tests/                      # Testes integrados
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_common/            # Testes biblioteca comum
‚îÇ   ‚îú‚îÄ‚îÄ test_omie/              # Testes espec√≠ficos Omie
‚îÇ   ‚îú‚îÄ‚îÄ test_nibo/              # Testes espec√≠ficos Nibo
‚îÇ   ‚îî‚îÄ‚îÄ test_integration/       # Testes de integra√ß√£o
‚îú‚îÄ‚îÄ docs/                       # Documenta√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md         # Arquitetura geral
‚îÇ   ‚îú‚îÄ‚îÄ NAMING_STANDARD.md      # Padr√£o de nomenclatura
‚îÇ   ‚îú‚îÄ‚îÄ DEVELOPMENT_GUIDE.md    # Guia de desenvolvimento
‚îÇ   ‚îî‚îÄ‚îÄ DEPLOYMENT_GUIDE.md     # Guia de deploy
‚îú‚îÄ‚îÄ config/                     # Configura√ß√µes globais
‚îÇ   ‚îú‚îÄ‚îÄ naming_mappings.json    # Mapeamentos de nomenclatura
‚îÇ   ‚îî‚îÄ‚îÄ erp_definitions.json    # Defini√ß√µes de ERPs
‚îî‚îÄ‚îÄ requirements.txt            # Depend√™ncias comuns
```

## üîß Implementa√ß√£o da Biblioteca Comum

### 1. Autentica√ß√£o Padronizada

```python
# common/auth/base_auth.py
from abc import ABC, abstractmethod
from typing import Dict, Any, Optional

class BaseAuth(ABC):
    """Classe base para autentica√ß√£o em ERPs"""
    
    def __init__(self, credentials: Dict[str, Any]):
        self.credentials = credentials
        self.token = None
        self.expires_at = None
    
    @abstractmethod
    async def authenticate(self) -> bool:
        """Autentica com o ERP"""
        pass
    
    @abstractmethod
    async def refresh_token(self) -> bool:
        """Renova token de autentica√ß√£o"""
        pass
    
    @abstractmethod
    def get_headers(self) -> Dict[str, str]:
        """Retorna headers para requisi√ß√µes"""
        pass
```

### 2. Servidor MCP Base

```python
# common/mcp/base_server.py
import asyncio
import json
import logging
from typing import Dict, Any, List
from abc import ABC, abstractmethod

class BaseMCPServer(ABC):
    """Classe base para servidores MCP"""
    
    def __init__(self, server_name: str, version: str):
        self.server_name = server_name
        self.version = version
        self.logger = logging.getLogger(server_name)
        self.tools = self.get_tools()
    
    @abstractmethod
    def get_tools(self) -> List[Dict[str, Any]]:
        """Retorna lista de ferramentas dispon√≠veis"""
        pass
    
    @abstractmethod
    async def call_tool(self, tool_name: str, arguments: Dict[str, Any]) -> Any:
        """Executa ferramenta espec√≠fica"""
        pass
    
    def send_response(self, response: Dict[str, Any]) -> None:
        """Envia resposta MCP via stdout"""
        response_json = json.dumps(response, ensure_ascii=False)
        print(response_json, flush=True)
```

### 3. Nomenclatura Universal

```python
# common/naming/universal_names.py
from typing import Dict, Any, Optional

class UniversalNaming:
    """Gerenciador de nomenclatura universal"""
    
    def __init__(self, mappings_file: str = None):
        self.mappings = self.load_mappings(mappings_file)
    
    def get_universal_name(self, platform: str, native_name: str) -> str:
        """Converte nome nativo para universal"""
        platform_mappings = self.mappings.get(platform, {})
        return platform_mappings.get(native_name, native_name)
    
    def get_native_name(self, platform: str, universal_name: str) -> str:
        """Converte nome universal para nativo"""
        reverse_mappings = self.get_reverse_mappings(platform)
        return reverse_mappings.get(universal_name, universal_name)
    
    def map_parameters(self, platform: str, universal_params: Dict[str, Any]) -> Dict[str, Any]:
        """Mapeia par√¢metros universais para formato nativo"""
        mapped_params = {}
        for key, value in universal_params.items():
            native_key = self.get_native_name(platform, key)
            mapped_params[native_key] = value
        return mapped_params
```

## üöÄ Migra√ß√£o Passo a Passo

### **Fase 1: Prepara√ß√£o da Biblioteca Comum**

1. **Criar estrutura base**
   ```bash
   mkdir -p erp-mcp-ecosystem/common/{auth,tools,naming,utils,mcp,config}
   ```

2. **Implementar classes base**
   - BaseAuth para autentica√ß√£o
   - BaseMCPServer para servidores
   - UniversalNaming para nomenclatura
   - BaseConfig para configura√ß√£o

3. **Migrar utilit√°rios comuns**
   - Validadores de documento
   - Formatadores de data
   - Cliente HTTP base

### **Fase 2: Migra√ß√£o do Omie-MCP**

1. **Criar servidor independente**
   ```bash
   mkdir -p erp-mcp-ecosystem/omie-mcp/{client,tools,config}
   ```

2. **Migrar ferramentas existentes**
   - Adaptar para usar biblioteca comum
   - Implementar nomenclatura universal
   - Configurar autentica√ß√£o padr√£o

3. **Testes de compatibilidade**
   - Validar funcionamento com Claude Desktop
   - Verificar todas as 20 ferramentas
   - Testar autentica√ß√£o e rate limiting

### **Fase 3: Migra√ß√£o do Nibo-MCP**

1. **Criar servidor independente**
   ```bash
   mkdir -p erp-mcp-ecosystem/nibo-mcp/{client,tools,config}
   ```

2. **Migrar ferramentas existentes**
   - Adaptar para usar biblioteca comum
   - Implementar nomenclatura universal
   - Configurar autentica√ß√£o padr√£o

3. **Preservar funcionalidades exclusivas**
   - Ferramentas de s√≥cios
   - Opera√ß√µes em lote
   - Funcionalidades espec√≠ficas do Nibo

### **Fase 4: Prepara√ß√£o para Novos ERPs**

1. **Criar templates**
   - Template de servidor MCP
   - Template de cliente ERP
   - Template de ferramentas

2. **Documenta√ß√£o**
   - Guia de desenvolvimento
   - Padr√µes de nomenclatura
   - Exemplos de implementa√ß√£o

## üìä Benef√≠cios da Nova Arquitetura

### **1. Flexibilidade**
- ‚úÖ Clientes ativam apenas ERPs necess√°rios
- ‚úÖ Escalabilidade independente por ERP
- ‚úÖ Falhas isoladas n√£o afetam outros ERPs

### **2. Manutenibilidade**
- ‚úÖ C√≥digo simples e focado por ERP
- ‚úÖ Biblioteca comum reduz duplica√ß√£o
- ‚úÖ Testes isolados e espec√≠ficos

### **3. Desenvolvimento**
- ‚úÖ Equipes podem especializar por ERP
- ‚úÖ Novos ERPs seguem padr√£o estabelecido
- ‚úÖ Nomenclatura universal facilita integra√ß√£o

### **4. Operacional**
- ‚úÖ Deploy independente por ERP
- ‚úÖ Monitoramento espec√≠fico
- ‚úÖ Logs isolados por plataforma

## üéØ Resultados Esperados

1. **Redu√ß√£o de Complexidade**: Cada servidor √© simples e focado
2. **Maior Confiabilidade**: Falhas isoladas n√£o propagam
3. **Facilidade de Manuten√ß√£o**: Mudan√ßas n√£o afetam outros ERPs
4. **Escalabilidade**: Recursos alocados por demanda
5. **Experi√™ncia do Cliente**: Ativa√ß√£o seletiva por ERP

## üìã Pr√≥ximos Passos

1. **Implementar biblioteca comum**
2. **Migrar Omie-MCP para nova estrutura**
3. **Migrar Nibo-MCP para nova estrutura**
4. **Criar templates para novos ERPs**
5. **Documentar padr√µes e processos**

---

**Esta arquitetura posiciona o Uptax Manager como l√≠der em padroniza√ß√£o de integra√ß√£o ERP, oferecendo flexibilidade m√°xima para clientes e simplicidade m√°xima para desenvolvedores.**