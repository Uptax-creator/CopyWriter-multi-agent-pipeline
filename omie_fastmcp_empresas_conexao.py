#!/usr/bin/env python3
"""
üéØ OMIE FASTMCP - FERRAMENTAS DE CONEX√ÉO E EMPRESAS
Implementa teste de conex√£o e listagem de empresas ativas
"""

import asyncio
import os
import sys
import json
from typing import Optional, Dict, Any, List
from datetime import datetime, timedelta
from fastmcp import FastMCP

# Adicionar src ao path
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

try:
    from src.client.omie_client import OmieClient
except ImportError:
    print("Erro: N√£o foi poss√≠vel importar OmieClient")
    sys.exit(1)

# Criar inst√¢ncia FastMCP
mcp = FastMCP("Omie ERP - Conex√£o e Empresas üîåüè¢")

# Inst√¢ncia global
omie_client = None

async def initialize_system():
    """Inicializa cliente Omie"""
    global omie_client
    if omie_client is None:
        omie_client = OmieClient()
    return omie_client

async def get_omie_client():
    """Obt√©m cliente Omie inicializado"""
    return await initialize_system()

def format_response(status: str, data: Any, **kwargs) -> str:
    """Formatar resposta padronizada"""
    response = {
        "timestamp": datetime.now().isoformat(),
        "status": status,
        "data": data,
        **kwargs
    }
    
    return json.dumps(response, ensure_ascii=False, indent=2, default=str)

@mcp.tool()
async def teste_conexao() -> str:
    """
    Testa a conectividade com a API Omie ERP
    
    Implementa√ß√£o baseada no projeto anterior homologado.
    Realiza uma consulta simples para verificar conectividade.
    
    Returns:
        String com resultado do teste de conex√£o
        
    Examples:
        - teste_conexao() - "‚úÖ Conex√£o com API Omie funcionando"
    """
    try:
        client = await get_omie_client()
        
        print("üîå Testando conex√£o com API Omie...")
        
        # Usar a mesma estrat√©gia do projeto anterior: testar com listar_clientes
        resultado = await client.listar_clientes({"pagina": 1, "registros_por_pagina": 1})
        
        if resultado:
            return "‚úÖ Conex√£o com API Omie funcionando"
        else:
            return "‚ùå Erro na conex√£o: resposta vazia"
            
    except Exception as e:
        return f"‚ùå Erro na conex√£o: {str(e)}"

@mcp.tool()
async def listar_empresas_ativas() -> str:
    """
    Lista empresas ativas no Omie ERP
    
    Implementa√ß√£o baseada no projeto anterior homologado.
    Tenta acessar informa√ß√µes da empresa via API Omie.
    
    Returns:
        String com informa√ß√µes das empresas ativas
        
    Examples:
        - listar_empresas_ativas() - Lista empresas cadastradas
    """
    try:
        client = await get_omie_client()
        
        print("üè¢ Consultando empresas ativas...")
        
        # Tentar endpoint de empresas
        try:
            resultado = await client._make_request("geral/empresas", "ListarEmpresas", {})
            
            if resultado:
                return f"üè¢ Empresas encontradas: {len(resultado) if isinstance(resultado, list) else 1}\n\nüìã Dados: {str(resultado)[:500]}..."
            else:
                return "‚ö†Ô∏è Nenhuma empresa encontrada"
                
        except Exception as e:
            # Fallback: informa√ß√µes b√°sicas
            test_result = await client.consultar_categorias({"pagina": 1, "registros_por_pagina": 1})
            if test_result:
                return "üè¢ Empresa ativa detectada\n\nüìã API conectada e operacional\nüí° Para informa√ß√µes detalhadas, verificar permiss√µes espec√≠ficas"
            else:
                return f"‚ùå Erro ao consultar empresas: {str(e)[:100]}"
        
    except Exception as e:
        return f"‚ùå Erro ao listar empresas: {str(e)}"

@mcp.tool() 
async def dados_empresa_ativa() -> str:
    """
    Obt√©m dados detalhados da empresa ativa no Omie ERP
    
    Implementa√ß√£o baseada no projeto anterior homologado.
    Consulta informa√ß√µes espec√≠ficas da empresa em uso.
    
    Returns:
        String com dados da empresa ativa
        
    Examples:
        - dados_empresa_ativa() - Mostra informa√ß√µes detalhadas da empresa
    """
    try:
        client = await get_omie_client()
        
        print("üìä Consultando dados da empresa ativa...")
        
        # Tentar diferentes endpoints para informa√ß√µes da empresa
        endpoints_empresa = [
            {"endpoint": "geral/empresas", "call": "ListarEmpresas"},
            {"endpoint": "geral/informacoes", "call": "InformacoesEmpresa"},
            {"endpoint": "geral/empresa", "call": "ConsultarEmpresa"}
        ]
        
        for endpoint_info in endpoints_empresa:
            try:
                resultado = await client._make_request(
                    endpoint_info["endpoint"], 
                    endpoint_info["call"], 
                    {}
                )
                
                if resultado:
                    # Processar dados da empresa
                    if isinstance(resultado, list) and len(resultado) > 0:
                        empresa = resultado[0]
                    elif isinstance(resultado, dict):
                        empresa = resultado
                    else:
                        continue
                    
                    # Formatar informa√ß√µes
                    info_empresa = []
                    info_empresa.append("üìã DADOS DA EMPRESA ATIVA")
                    info_empresa.append("=" * 30)
                    
                    # Informa√ß√µes b√°sicas
                    if empresa.get("razao_social"):
                        info_empresa.append(f"üè¢ Raz√£o Social: {empresa['razao_social']}")
                    if empresa.get("nome_fantasia"):
                        info_empresa.append(f"üè™ Nome Fantasia: {empresa['nome_fantasia']}")
                    if empresa.get("cnpj_cpf") or empresa.get("cnpj"):
                        cnpj = empresa.get("cnpj_cpf", empresa.get("cnpj", ""))
                        info_empresa.append(f"üìÑ CNPJ: {cnpj}")
                    if empresa.get("inscricao_estadual"):
                        info_empresa.append(f"üÜî IE: {empresa['inscricao_estadual']}")
                    
                    # Informa√ß√µes de contato
                    if empresa.get("email"):
                        info_empresa.append(f"üìß Email: {empresa['email']}")
                    if empresa.get("telefone1_ddd") and empresa.get("telefone1_numero"):
                        tel = f"({empresa['telefone1_ddd']}) {empresa['telefone1_numero']}"
                        info_empresa.append(f"üìû Telefone: {tel}")
                    
                    # Endere√ßo
                    endereco_parts = []
                    if empresa.get("endereco"):
                        endereco_parts.append(empresa["endereco"])
                    if empresa.get("endereco_numero"):
                        endereco_parts.append(empresa["endereco_numero"])
                    if empresa.get("bairro"):
                        endereco_parts.append(empresa["bairro"])
                    if empresa.get("cidade") and empresa.get("estado"):
                        endereco_parts.append(f"{empresa['cidade']}/{empresa['estado']}")
                    
                    if endereco_parts:
                        info_empresa.append(f"üìç Endere√ßo: {', '.join(endereco_parts)}")
                    
                    # Status e outras informa√ß√µes
                    status = "ATIVA" if empresa.get("inativo", "N") == "N" else "INATIVA"
                    info_empresa.append(f"‚úÖ Status: {status}")
                    
                    if empresa.get("regime_tributario"):
                        info_empresa.append(f"üíº Regime: {empresa['regime_tributario']}")
                    
                    return "\n".join(info_empresa)
                
            except Exception:
                continue
        
        # Fallback: informa√ß√µes b√°sicas via teste
        try:
            test_result = await client.consultar_categorias({"pagina": 1, "registros_por_pagina": 1})
            if test_result:
                return "üìã DADOS DA EMPRESA ATIVA\n" + \
                       "=" * 30 + "\n" + \
                       "üè¢ Empresa: Conectada e Operacional\n" + \
                       "‚úÖ Status: ATIVA\n" + \
                       "üìä API: Funcionando\n\n" + \
                       "üí° Para dados detalhados, verificar permiss√µes de acesso espec√≠ficas"
            else:
                return "‚ùå N√£o foi poss√≠vel obter dados da empresa"
                
        except Exception as e:
            return f"‚ùå Erro ao obter dados da empresa: {str(e)[:100]}"
        
    except Exception as e:
        return f"‚ùå Erro ao consultar dados da empresa: {str(e)}"

@mcp.tool()
async def status_sistema_omie() -> str:
    """
    Retorna status geral do sistema Omie ERP
    
    Combina teste de conex√£o e informa√ß√µes b√°sicas da empresa
    para fornecer um panorama geral do sistema.
    
    Returns:
        JSON com status geral, conectividade e informa√ß√µes b√°sicas
    """
    try:
        print("üìä Verificando status geral do sistema Omie...")
        
        start_time = datetime.now()
        
        # Executar testes em paralelo seria ideal, mas para simplicidade vamos fazer sequencial
        conexao_result = await teste_conexao()
        empresas_result = await listar_empresas_ativas()
        
        # Parse dos resultados JSON
        import json
        conexao_data = json.loads(conexao_result)
        empresas_data = json.loads(empresas_result)
        
        # Determinar status geral
        conexao_ok = conexao_data.get("status") == "success"
        empresas_ok = empresas_data.get("status") in ["success", "partial_success"]
        
        overall_status = "operational" if conexao_ok and empresas_ok else "issues_detected"
        
        total_time = (datetime.now() - start_time).total_seconds() * 1000
        
        return format_response(
            overall_status,
            {
                "connectivity": {
                    "status": "OK" if conexao_ok else "ISSUES",
                    "latency_ms": conexao_data.get("data", {}).get("connection_test", {}).get("latency_ms", 0)
                },
                "companies": {
                    "status": "OK" if empresas_ok else "LIMITED",
                    "active_companies": empresas_data.get("total_empresas_ativas", 0)
                },
                "system_health": {
                    "overall": "HEALTHY" if overall_status == "operational" else "DEGRADED",
                    "api_responsive": conexao_ok,
                    "data_accessible": empresas_ok
                }
            },
            total_execution_time_ms=round(total_time, 2),
            recommendations=[
                "Sistema operacional - todas as verifica√ß√µes OK" if overall_status == "operational"
                else "Algumas limita√ß√µes detectadas - verificar logs espec√≠ficos",
                "Conectividade adequada para uso em produ√ß√£o" if conexao_ok
                else "Problemas de conectividade requerem aten√ß√£o"
            ]
        )
        
    except Exception as e:
        return format_response(
            "error",
            f"Erro ao verificar status do sistema: {str(e)}",
            error_type=type(e).__name__
        )

# Executar servidor se chamado diretamente
if __name__ == "__main__":
    print("üéØ OMIE FASTMCP - CONEX√ÉO E EMPRESAS")
    print("=" * 50)
    print("üìä Tools dispon√≠veis:")
    print("   1. teste_conexao - Verifica conectividade com API Omie")
    print("   2. listar_empresas_ativas - Lista empresas ativas")
    print("   3. status_sistema_omie - Status geral do sistema")
    print()
    print("üöÄ Iniciando servidor MCP...")
    
    mcp.run()