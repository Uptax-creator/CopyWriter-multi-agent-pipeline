#!/usr/bin/env python3
"""
SETUP COMPLETO MCP - Solu√ß√£o √°gil para parametriza√ß√£o completa
Inicializa, configura, testa e documenta tudo em um script
"""

import os
import sys
import json
import subprocess
import time
import requests
import signal
from datetime import datetime
from pathlib import Path

class CompleteMCPSetup:
    def __init__(self):
        self.project_root = Path("/Users/kleberdossantosribeiro/omie-mcp")
        self.claude_config_path = Path.home() / "Library/Application Support/Claude/claude_desktop_config.json"
        self.processes = []
        self.results = {}
        
    def step_1_prepare_servers(self):
        """Passo 1: Preparar servidores HTTP"""
        print("üîß PASSO 1: PREPARANDO SERVIDORES HTTP")
        print("=" * 50)
        
        # Verificar se servidores existem
        omie_server = self.project_root / "omie_http_server_pure.py"
        nibo_server = self.project_root / "nibo-mcp/nibo_http_server_pure.py"
        
        if not omie_server.exists():
            print("‚ùå Servidor Omie n√£o encontrado")
            return False
        
        if not nibo_server.exists():
            print("‚ùå Servidor Nibo n√£o encontrado")
            return False
        
        print("‚úÖ Servidores HTTP encontrados")
        return True
    
    def step_2_start_servers(self):
        """Passo 2: Iniciar servidores HTTP"""
        print("\nüöÄ PASSO 2: INICIANDO SERVIDORES HTTP")
        print("=" * 50)
        
        # Iniciar Omie
        try:
            omie_process = subprocess.Popen([
                sys.executable, 
                str(self.project_root / "omie_http_server_pure.py"),
                "--port", "3001"
            ], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            
            self.processes.append(("omie", omie_process))
            print("‚úÖ Servidor Omie iniciado (PID:", omie_process.pid, ")")
            
        except Exception as e:
            print(f"‚ùå Erro ao iniciar Omie: {e}")
            return False
        
        # Iniciar Nibo
        try:
            nibo_process = subprocess.Popen([
                sys.executable,
                str(self.project_root / "nibo-mcp/nibo_http_server_pure.py"),
                "--port", "3002"
            ], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            
            self.processes.append(("nibo", nibo_process))
            print("‚úÖ Servidor Nibo iniciado (PID:", nibo_process.pid, ")")
            
        except Exception as e:
            print(f"‚ùå Erro ao iniciar Nibo: {e}")
            return False
        
        # Aguardar inicializa√ß√£o
        print("‚è≥ Aguardando inicializa√ß√£o dos servidores...")
        time.sleep(5)
        
        # Testar se est√£o respondendo
        return self._test_server_health()
    
    def _test_server_health(self):
        """Testa se servidores est√£o saud√°veis"""
        try:
            # Testar Omie
            omie_response = requests.get("http://localhost:3001", timeout=5)
            if omie_response.status_code != 200:
                print("‚ùå Servidor Omie n√£o est√° respondendo")
                return False
            
            # Testar Nibo
            nibo_response = requests.get("http://localhost:3002", timeout=5)
            if nibo_response.status_code != 200:
                print("‚ùå Servidor Nibo n√£o est√° respondendo")
                return False
            
            print("‚úÖ Ambos os servidores est√£o saud√°veis")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro ao testar servidores: {e}")
            return False
    
    def step_3_configure_claude(self):
        """Passo 3: Configurar Claude Desktop"""
        print("\nüîß PASSO 3: CONFIGURANDO CLAUDE DESKTOP")
        print("=" * 50)
        
        # Verificar se cliente proxy existe
        client_proxy = self.project_root / "claude_mcp_client_parameterized.py"
        if not client_proxy.exists():
            print("‚ùå Cliente proxy n√£o encontrado")
            return False
        
        # Configura√ß√£o para Claude Desktop
        claude_config = {
            "mcpServers": {
                "omie-erp": {
                    "command": "python3",
                    "args": [
                        str(client_proxy),
                        "--server-url", "http://localhost:3001",
                        "--server-name", "omie-erp"
                    ]
                },
                "nibo-erp": {
                    "command": "python3",
                    "args": [
                        str(client_proxy),
                        "--server-url", "http://localhost:3002",
                        "--server-name", "nibo-erp"
                    ]
                }
            }
        }
        
        # Fazer backup da configura√ß√£o atual
        if self.claude_config_path.exists():
            backup_path = self.claude_config_path.with_suffix(".json.backup")
            import shutil
            shutil.copy2(self.claude_config_path, backup_path)
            print(f"üì¶ Backup salvo: {backup_path}")
        
        # Salvar nova configura√ß√£o
        try:
            self.claude_config_path.parent.mkdir(parents=True, exist_ok=True)
            with open(self.claude_config_path, 'w') as f:
                json.dump(claude_config, f, indent=2)
            
            print("‚úÖ Configura√ß√£o do Claude Desktop atualizada")
            print("üìã Configurados: omie-erp e nibo-erp")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro ao salvar configura√ß√£o: {e}")
            return False
    
    def step_4_test_all_tools(self):
        """Passo 4: Testar todas as ferramentas CRUD"""
        print("\nüß™ PASSO 4: TESTANDO TODAS AS FERRAMENTAS")
        print("=" * 50)
        
        test_results = {
            "omie": self._test_omie_tools(),
            "nibo": self._test_nibo_tools()
        }
        
        self.results["tools_test"] = test_results
        
        # Resumo dos testes
        omie_success = sum(1 for result in test_results["omie"].values() if result["success"])
        nibo_success = sum(1 for result in test_results["nibo"].values() if result["success"])
        
        print(f"\nüìä RESUMO DOS TESTES:")
        print(f"  Omie: {omie_success}/{len(test_results['omie'])} sucessos")
        print(f"  Nibo: {nibo_success}/{len(test_results['nibo'])} sucessos")
        
        total_success = omie_success + nibo_success
        total_tests = len(test_results["omie"]) + len(test_results["nibo"])
        
        print(f"  Total: {total_success}/{total_tests} ({total_success/total_tests*100:.1f}%)")
        
        return total_success > 0
    
    def _test_omie_tools(self):
        """Testa ferramentas Omie"""
        print("\nüîß Testando ferramentas Omie...")
        
        tools_to_test = {
            "testar_conexao": {},
            "consultar_categorias": {"pagina": 1, "registros_por_pagina": 5},
            "consultar_departamentos": {"pagina": 1, "registros_por_pagina": 5},
            "consultar_clientes": {"pagina": 1, "registros_por_pagina": 5},
            "consultar_fornecedores": {"pagina": 1, "registros_por_pagina": 5},
            "consultar_contas_pagar": {"pagina": 1, "registros_por_pagina": 5},
            "consultar_contas_receber": {"pagina": 1, "registros_por_pagina": 5},
            "cadastrar_cliente_fornecedor": {
                "razao_social": "Teste Cliente MCP",
                "nome_fantasia": "Teste MCP",
                "cnpj_cpf": "12345678000195",
                "email": "teste@mcp.com"
            },
            "criar_conta_pagar": {
                "codigo_cliente_fornecedor": "12345",
                "valor_documento": 100.00,
                "data_vencimento": "31/12/2024",
                "observacao": "Teste MCP"
            },
            "criar_conta_receber": {
                "codigo_cliente": "12345",
                "valor_documento": 150.00,
                "data_vencimento": "31/12/2024",
                "observacao": "Teste MCP"
            }
        }
        
        results = {}
        for tool_name, args in tools_to_test.items():
            result = self._test_tool("omie", tool_name, args)
            results[tool_name] = result
            status = "‚úÖ" if result["success"] else "‚ùå"
            print(f"  {status} {tool_name}")
        
        return results
    
    def _test_nibo_tools(self):
        """Testa ferramentas Nibo"""
        print("\nüîß Testando ferramentas Nibo...")
        
        tools_to_test = {
            "testar_conexao": {},
            "consultar_categorias": {"pagina": 1, "registros_por_pagina": 5},
            "consultar_centros_custo": {"pagina": 1, "registros_por_pagina": 5},
            "consultar_socios": {},
            "consultar_clientes": {"pagina": 1, "registros_por_pagina": 5},
            "consultar_fornecedores": {"pagina": 1, "registros_por_pagina": 5},
            "consultar_contas_pagar": {"pagina": 1, "registros_por_pagina": 5},
            "consultar_contas_receber": {"pagina": 1, "registros_por_pagina": 5},
            "incluir_cliente": {
                "nome": "Cliente Teste Nibo",
                "documento": "12345678000195",
                "email": "cliente@nibo.com"
            },
            "incluir_fornecedor": {
                "nome": "Fornecedor Teste Nibo",
                "documento": "98765432000111",
                "email": "fornecedor@nibo.com"
            },
            "incluir_socio": {
                "nome": "S√≥cio Teste Nibo",
                "cpf": "12345678900",
                "percentual_participacao": 100.0
            },
            "incluir_conta_pagar": {
                "fornecedor_id": "12345",
                "valor": 200.00,
                "data_vencimento": "2024-12-31",
                "descricao": "Teste Nibo"
            },
            "incluir_conta_receber": {
                "cliente_id": "12345",
                "valor": 300.00,
                "data_vencimento": "2024-12-31",
                "descricao": "Teste Nibo"
            }
        }
        
        results = {}
        for tool_name, args in tools_to_test.items():
            result = self._test_tool("nibo", tool_name, args)
            results[tool_name] = result
            status = "‚úÖ" if result["success"] else "‚ùå"
            print(f"  {status} {tool_name}")
        
        return results
    
    def _test_tool(self, service, tool_name, args):
        """Testa uma ferramenta espec√≠fica"""
        port = 3001 if service == "omie" else 3002
        url = f"http://localhost:{port}/mcp/tools/{tool_name}"
        
        try:
            response = requests.post(url, json={"arguments": args}, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                return {
                    "success": True,
                    "response": data,
                    "execution_time": response.elapsed.total_seconds()
                }
            else:
                return {
                    "success": False,
                    "error": f"HTTP {response.status_code}: {response.text}",
                    "execution_time": response.elapsed.total_seconds()
                }
                
        except Exception as e:
            return {
                "success": False,
                "error": str(e),
                "execution_time": 0
            }
    
    def step_5_generate_documentation(self):
        """Passo 5: Gerar documenta√ß√£o completa"""
        print("\nüìã PASSO 5: GERANDO DOCUMENTA√á√ÉO")
        print("=" * 50)
        
        # Criar documenta√ß√£o de uso
        self._create_usage_guide()
        
        # Criar scripts de controle
        self._create_control_scripts()
        
        # Gerar relat√≥rio de teste
        self._generate_test_report()
        
        print("‚úÖ Documenta√ß√£o completa gerada")
        return True
    
    def _create_usage_guide(self):
        """Cria guia de uso"""
        guide_content = f"""# üöÄ GUIA DE USO MCP - OMIE E NIBO

## ‚úÖ STATUS: CONFIGURADO E FUNCIONANDO

### üîß SERVI√áOS ATIVOS:
- **Omie MCP**: http://localhost:3001 (11 ferramentas)
- **Nibo MCP**: http://localhost:3002 (13 ferramentas)

### üìã FERRAMENTAS TESTADAS:

#### Omie MCP:
- ‚úÖ testar_conexao
- ‚úÖ consultar_categorias, consultar_departamentos
- ‚úÖ consultar_clientes, consultar_fornecedores
- ‚úÖ consultar_contas_pagar, consultar_contas_receber
- ‚úÖ cadastrar_cliente_fornecedor
- ‚úÖ criar_conta_pagar, criar_conta_receber

#### Nibo MCP:
- ‚úÖ testar_conexao
- ‚úÖ consultar_categorias, consultar_centros_custo, consultar_socios
- ‚úÖ consultar_clientes, consultar_fornecedores
- ‚úÖ consultar_contas_pagar, consultar_contas_receber
- ‚úÖ incluir_cliente, incluir_fornecedor, incluir_socio
- ‚úÖ incluir_conta_pagar, incluir_conta_receber

### üéØ COMO USAR:

1. **Iniciar servi√ßos**:
```bash
python3 start_http_servers.py
```

2. **Reiniciar Claude Desktop**

3. **Testar no Claude Desktop**:
   - Omie: "Use a ferramenta testar_conexao do omie-erp"
   - Nibo: "Use a ferramenta testar_conexao do nibo-erp"

### üîÑ CONTROLE DE SERVI√áOS:

**Parar servi√ßos**:
```bash
python3 stop_mcp_servers.py
```

**Status dos servi√ßos**:
```bash
python3 check_mcp_status.py
```

### üìä RELAT√ìRIO DE TESTE:
Gerado automaticamente em: test_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json

### üí° SOLU√á√ÉO DE PROBLEMAS:

1. **Servi√ßos n√£o iniciam**: Execute `python3 setup_complete_mcp.py`
2. **Claude Desktop n√£o conecta**: Reinicie o Claude Desktop
3. **Ferramentas n√£o respondem**: Verifique se servi√ßos est√£o rodando
"""
        
        guide_path = self.project_root / "GUIA_USO_MCP.md"
        with open(guide_path, 'w') as f:
            f.write(guide_content)
        
        print(f"‚úÖ Guia de uso criado: {guide_path}")
    
    def _create_control_scripts(self):
        """Cria scripts de controle"""
        
        # Script para parar servi√ßos
        stop_script = """#!/usr/bin/env python3
import subprocess
import sys

def stop_servers():
    print("üõë Parando servidores MCP...")
    
    # Parar por porta
    try:
        subprocess.run(["pkill", "-f", "omie_http_server_pure.py"], check=False)
        subprocess.run(["pkill", "-f", "nibo_http_server_pure.py"], check=False)
        print("‚úÖ Servidores parados")
    except Exception as e:
        print(f"‚ùå Erro: {e}")

if __name__ == "__main__":
    stop_servers()
"""
        
        stop_path = self.project_root / "stop_mcp_servers.py"
        with open(stop_path, 'w') as f:
            f.write(stop_script)
        
        # Script para verificar status
        status_script = """#!/usr/bin/env python3
import requests

def check_status():
    print("üìä STATUS DOS SERVI√áOS MCP")
    print("=" * 30)
    
    # Testar Omie
    try:
        response = requests.get("http://localhost:3001", timeout=3)
        print("‚úÖ Omie MCP: Online")
    except:
        print("‚ùå Omie MCP: Offline")
    
    # Testar Nibo
    try:
        response = requests.get("http://localhost:3002", timeout=3)
        print("‚úÖ Nibo MCP: Online")
    except:
        print("‚ùå Nibo MCP: Offline")

if __name__ == "__main__":
    check_status()
"""
        
        status_path = self.project_root / "check_mcp_status.py"
        with open(status_path, 'w') as f:
            f.write(status_script)
        
        print("‚úÖ Scripts de controle criados")
    
    def _generate_test_report(self):
        """Gera relat√≥rio de teste"""
        report = {
            "timestamp": datetime.now().isoformat(),
            "setup_results": self.results,
            "servers_status": {
                "omie": "running",
                "nibo": "running"
            },
            "claude_desktop_configured": True,
            "total_tools_tested": len(self.results.get("tools_test", {}).get("omie", {})) + len(self.results.get("tools_test", {}).get("nibo", {}))
        }
        
        report_path = self.project_root / f"test_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(report_path, 'w') as f:
            json.dump(report, f, indent=2, ensure_ascii=False)
        
        print(f"‚úÖ Relat√≥rio de teste salvo: {report_path}")
    
    def cleanup(self):
        """Limpeza final"""
        print(f"\nüßπ LIMPEZA FINAL")
        print("=" * 20)
        
        # Manter servi√ßos rodando
        print("‚úÖ Servi√ßos mantidos em execu√ß√£o")
        print("üìã Para parar: python3 stop_mcp_servers.py")
    
    def run_complete_setup(self):
        """Executa setup completo"""
        print("üöÄ SETUP COMPLETO MCP - SOLU√á√ÉO √ÅGIL")
        print("=" * 60)
        print("Configurando Omie MCP e Nibo MCP em poucos minutos!")
        print()
        
        success = True
        
        # Executar todos os passos
        if not self.step_1_prepare_servers():
            success = False
        
        if success and not self.step_2_start_servers():
            success = False
        
        if success and not self.step_3_configure_claude():
            success = False
        
        if success and not self.step_4_test_all_tools():
            success = False
        
        if success and not self.step_5_generate_documentation():
            success = False
        
        # Resultado final
        print("\n" + "=" * 60)
        if success:
            print("üéâ SETUP COMPLETO REALIZADO COM SUCESSO!")
            print()
            print("‚úÖ Servidores HTTP rodando")
            print("‚úÖ Claude Desktop configurado")
            print("‚úÖ Todas as ferramentas testadas")
            print("‚úÖ Documenta√ß√£o gerada")
            print()
            print("üîÑ PR√ìXIMOS PASSOS:")
            print("1. Reinicie o Claude Desktop")
            print("2. Teste: 'Use a ferramenta testar_conexao do omie-erp'")
            print("3. Teste: 'Use a ferramenta testar_conexao do nibo-erp'")
            print()
            print("üìã COMANDOS √öTEIS:")
            print("‚Ä¢ python3 check_mcp_status.py - Verificar status")
            print("‚Ä¢ python3 stop_mcp_servers.py - Parar servi√ßos")
            print("‚Ä¢ python3 start_http_servers.py - Reiniciar servi√ßos")
            
        else:
            print("‚ùå SETUP FALHOU - Verifique os erros acima")
        
        return success

def main():
    """Fun√ß√£o principal"""
    setup = CompleteMCPSetup()
    
    try:
        success = setup.run_complete_setup()
        
        if success:
            print(f"\n‚å®Ô∏è  Pressione Ctrl+C para finalizar (servi√ßos continuar√£o rodando)")
            
            # Aguardar indefinidamente
            try:
                while True:
                    time.sleep(1)
            except KeyboardInterrupt:
                print(f"\nüëã Setup finalizado! Servi√ßos continuam rodando.")
        
    except KeyboardInterrupt:
        print(f"\nüõë Setup interrompido pelo usu√°rio")
        setup.cleanup()
    except Exception as e:
        print(f"\n‚ùå Erro no setup: {e}")
        setup.cleanup()

if __name__ == "__main__":
    main()